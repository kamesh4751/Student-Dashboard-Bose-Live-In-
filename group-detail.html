<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Group Details - ConnectedX</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f9fafb;
    }
    .dark-gradient {
      background: linear-gradient(180deg, #1f2937 0%, #374151 100%);
    }
    .sidebar { transition: width 0.3s; }
    .sidebar-collapsed { width: 60px; }
    .sidebar-expanded { width: 250px; }
    .main-content { transition: margin-left 0.3s; }
    .card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .tooltip {
      visibility: hidden;
      position: absolute;
      background-color: #1a202c;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 10;
      left: 70px;
    }
    .sidebar-collapsed .nav-item:hover .tooltip { visibility: visible; }
    .nav-item:hover { background-color: #4b5563; }
    .chat-container {
      height: 400px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .message-bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 18px;
      margin-bottom: 8px;
      word-wrap: break-word;
    }
    .message-sent {
      background-color: #3b82f6;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .message-received {
      background-color: #e5e7eb;
      color: #1f2937;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_URL = 'http://localhost:3001';

    const NavBar = ({ isSidebarCollapsed, toggleSidebar }) => {
      const navItems = [
        { name: 'Dashboard', path: 'index.html', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
        { name: 'Study Groups', path: 'study-groups.html', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' },
        { name: 'Messages', path: 'messages.html', icon: 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 4.582 9 8z' },
        { name: 'Settings', path: 'settings.html', icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z' },
      ];

      return (
        <div className={`sidebar dark-gradient ${isSidebarCollapsed ? 'sidebar-collapsed' : 'sidebar-expanded'} fixed top-0 left-0 h-screen text-white`}>
          <div className="flex items-center justify-between p-4">
            {!isSidebarCollapsed && <h2 className="text-xl font-semibold">ConnectedX</h2>}
            <button onClick={toggleSidebar} className="text-white focus:outline-none">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={isSidebarCollapsed ? 'M9 5h12M9 12h12M9 19h12' : 'M4 6h16M4 12h16M4 18h16'} />
              </svg>
            </button>
          </div>
          <nav>
            {navItems.map(item => (
              <a key={item.name} href={item.path} className="nav-item flex items-center p-4 relative">
                <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={item.icon} />
                </svg>
                {!isSidebarCollapsed && <span>{item.name}</span>}
                {isSidebarCollapsed && <span className="tooltip">{item.name}</span>}
              </a>
            ))}
          </nav>
        </div>
      );
    };

    const GroupDetailPage = () => {
      const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
      const [group, setGroup] = useState(null);
      const [messages, setMessages] = useState([]);
      const [newMessage, setNewMessage] = useState('');
      const [userId, setUserId] = useState('');
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const storedUserId = localStorage.getItem('userId');
        if (!storedUserId) {
          window.location.href = 'login.html';
          return;
        }
        setUserId(storedUserId);

        // Get group ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const groupId = urlParams.get('id');
        
        if (!groupId) {
          alert('No group ID provided');
          window.location.href = 'study-groups.html';
          return;
        }

        fetchGroupDetails(groupId);
        fetchMessages(groupId);
      }, []);

      const fetchGroupDetails = async (groupId) => {
        try {
          const res = await fetch(`${API_URL}/api/groups/${groupId}`);
          const data = await res.json();
          
          if (data.status === 'Success') {
            setGroup(data.group);
          } else {
            alert('Group not found');
            window.location.href = 'study-groups.html';
          }
          setLoading(false);
        } catch (err) {
          console.error('Error fetching group:', err);
          setLoading(false);
        }
      };

      const fetchMessages = async (groupId) => {
        try {
          const res = await fetch(`${API_URL}/api/groups/${groupId}/messages`);
          const data = await res.json();
          
          if (data.status === 'Success') {
            setMessages(data.messages);
          }
        } catch (err) {
          console.error('Error fetching messages:', err);
        }
      };

      const sendMessage = async (e) => {
        e.preventDefault();
        
        if (!newMessage.trim()) return;

        try {
          const res = await fetch(`${API_URL}/api/groups/${group._id}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              senderId: userId,
              content: newMessage,
              messageType: 'text'
            })
          });

          const data = await res.json();
          
          if (data.status === 'Success') {
            setMessages([...messages, data.message]);
            setNewMessage('');
            
            // Scroll to bottom
            setTimeout(() => {
              const chatContainer = document.querySelector('.chat-container');
              if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
              }
            }, 100);
          }
        } catch (err) {
          console.error('Error sending message:', err);
          alert('Failed to send message');
        }
      };

      const handleLeaveGroup = async () => {
        if (!window.confirm('Are you sure you want to leave this group?')) return;

        try {
          const res = await fetch(`${API_URL}/api/groups/${group._id}/leave`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId })
          });

          const data = await res.json();
          
          if (data.status === 'Success') {
            alert('Left group successfully');
            window.location.href = 'study-groups.html';
          }
        } catch (err) {
          console.error('Error leaving group:', err);
          alert('Failed to leave group');
        }
      };

      const handleDeleteGroup = async () => {
        if (!window.confirm('Are you sure you want to delete this group? This cannot be undone!')) return;

        try {
          const res = await fetch(`${API_URL}/api/groups/${group._id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId })
          });

          const data = await res.json();
          
          if (data.status === 'Success') {
            alert('Group deleted successfully');
            window.location.href = 'study-groups.html';
          } else {
            alert(data.message || 'Failed to delete group');
          }
        } catch (err) {
          console.error('Error deleting group:', err);
          alert('Failed to delete group');
        }
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center min-h-screen">
            <p className="text-gray-500">Loading group details...</p>
          </div>
        );
      }

      if (!group) {
        return (
          <div className="flex items-center justify-center min-h-screen">
            <p className="text-gray-500">Group not found</p>
          </div>
        );
      }

      const isMember = group.members.some(m => m.userId._id === userId);
      const isAdmin = group.createdBy._id === userId;

      return (
        <div>
          <NavBar isSidebarCollapsed={isSidebarCollapsed} toggleSidebar={() => setIsSidebarCollapsed(!isSidebarCollapsed)} />
          
          <div className={`main-content ${isSidebarCollapsed ? 'ml-[60px]' : 'ml-[250px]'} p-6 min-h-screen`}>
            {/* Header */}
            <div className="mb-6">
              <div className="flex items-center gap-3 mb-2">
                <a href="study-groups.html" className="text-blue-600 hover:underline flex items-center">
                  <svg className="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                  </svg>
                  Back to Groups
                </a>
              </div>
              <h1 className="text-3xl font-bold text-gray-800">{group.groupName}</h1>
              <p className="text-gray-600">{group.courseId.courseName} â€¢ {group.courseId.courseCode}</p>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* Left: Group Info & Members */}
              <div className="lg:col-span-1 space-y-6">
                {/* Group Info */}
                <div className="card p-6">
                  <h2 className="text-lg font-bold text-gray-800 mb-4">Group Information</h2>
                  
                  <div className="space-y-3 text-sm">
                    <div>
                      <span className="text-gray-500">Created by:</span>
                      <p className="font-medium text-gray-800">{group.createdBy.name}</p>
                    </div>
                    
                    <div>
                      <span className="text-gray-500">Type:</span>
                      <p className="font-medium text-gray-800 capitalize">{group.groupType}</p>
                    </div>
                    
                    <div>
                      <span className="text-gray-500">Members:</span>
                      <p className="font-medium text-gray-800">{group.members.length} / {group.maxMembers}</p>
                    </div>
                    
                    <div>
                      <span className="text-gray-500">Status:</span>
                      <p className="font-medium text-gray-800 capitalize">{group.status}</p>
                    </div>
                    
                    {group.description && (
                      <div>
                        <span className="text-gray-500">Description:</span>
                        <p className="text-gray-700 mt-1">{group.description}</p>
                      </div>
                    )}
                  </div>

                  {isMember && (
                    <div className="mt-6 space-y-2">
                      <button
                        onClick={handleLeaveGroup}
                        className="w-full bg-red-100 text-red-700 py-2 px-4 rounded-lg hover:bg-red-200 transition"
                      >
                        Leave Group
                      </button>
                      {isAdmin && (
                        <button
                          onClick={handleDeleteGroup}
                          className="w-full bg-gray-800 text-white py-2 px-4 rounded-lg hover:bg-gray-900 transition"
                        >
                          Delete Group
                        </button>
                      )}
                    </div>
                  )}
                </div>

                {/* Members List */}
                <div className="card p-6">
                  <h2 className="text-lg font-bold text-gray-800 mb-4">Members ({group.members.length})</h2>
                  <div className="space-y-3">
                    {group.members.map((member) => (
                      <div key={member.userId._id} className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <span className="text-blue-600 font-medium">
                              {member.userId.name.charAt(0).toUpperCase()}
                            </span>
                          </div>
                          <div>
                            <p className="font-medium text-gray-800">{member.userId.name}</p>
                            <p className="text-xs text-gray-500">{member.userId.email}</p>
                          </div>
                        </div>
                        {member.role === 'admin' && (
                          <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                            Admin
                          </span>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              {/* Right: Chat */}
              <div className="lg:col-span-2">
                <div className="card p-6">
                  <h2 className="text-lg font-bold text-gray-800 mb-4">Group Chat</h2>
                  
                  {!isMember ? (
                    <div className="text-center py-12 text-gray-500">
                      <p>You must be a member to view and send messages</p>
                      <p className="text-sm mt-2">Join the group to start chatting!</p>
                    </div>
                  ) : (
                    <>
                      {/* Messages */}
                      <div className="chat-container border border-gray-200 rounded-lg p-4 mb-4">
                        {messages.length === 0 ? (
                          <div className="text-center text-gray-500 py-8">
                            No messages yet. Start the conversation!
                          </div>
                        ) : (
                          messages.map((msg) => (
                            <div key={msg._id}>
                              <div className={`message-bubble ${
                                msg.senderId._id === userId ? 'message-sent' : 'message-received'
                              }`}>
                                {msg.senderId._id !== userId && (
                                  <p className="text-xs font-medium mb-1 opacity-70">
                                    {msg.senderId.name}
                                  </p>
                                )}
                                <p className="text-sm">{msg.content}</p>
                                <p className={`text-xs mt-1 ${
                                  msg.senderId._id === userId ? 'text-blue-100' : 'text-gray-500'
                                }`}>
                                  {new Date(msg.createdAt).toLocaleTimeString([], { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                  })}
                                </p>
                              </div>
                            </div>
                          ))
                        )}
                      </div>

                      {/* Send Message */}
                      <form onSubmit={sendMessage} className="flex gap-2">
                        <input
                          type="text"
                          value={newMessage}
                          onChange={(e) => setNewMessage(e.target.value)}
                          placeholder="Type your message..."
                          className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        />
                        <button
                          type="submit"
                          className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition"
                        >
                          Send
                        </button>
                      </form>
                    </>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<GroupDetailPage />);
  </script>
</body>
</html>