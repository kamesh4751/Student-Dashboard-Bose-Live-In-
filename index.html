<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ConnectedX Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: white;
    }

    .dark-gradient {
      background: linear-gradient(180deg, #1f2937 0%, #374151 100%);
    }

    .sidebar {
      transition: width 0.3s;
    }

    .sidebar-collapsed {
      width: 60px;
    }

    .sidebar-expanded {
      width: 250px;
    }

    .sidebar a {
      transition: background 0.2s;
    }

    .main-content {
      transition: margin-left 0.3s;
    }

    .card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .calendar-day {
      cursor: pointer;
    }

    .calendar-day:hover {
      background-color: #e5e7eb;
    }

    .calendar-day.today {
      background-color: #60a5fa;
      color: white;
    }

    .calendar-day.event {
      position: relative;
    }

    .calendar-day.event::after {
      content: '';
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      background-color: #60a5fa;
      border-radius: 50%;
    }

    .tooltip {
      visibility: hidden;
      position: absolute;
      background-color: #1a202c;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 10;
      left: 70px;
    }

    .sidebar-collapsed .nav-item:hover .tooltip {
      visibility: visible;
    }

    .nav-item:hover {
      background-color: #4b5563;
    }

    .link-hover:hover {
      color: #4b5563;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 0;
        overflow: hidden;
      }

      .sidebar-expanded {
        width: 250px;
      }

      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // API Base URL
    const API_URL = 'http://localhost:3001';

    const NavBar = ({ isSidebarCollapsed, toggleSidebar }) => {
      const navItems = [
        { name: 'Dashboard', path: 'index.html', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
        { name: 'Teachers', path: 'teachers.html', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' },
        { name: 'My Grades', path: 'grades.html', icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2' },
        { name: 'Study Groups', path: 'study-groups.html', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' },
        { name: 'My Profile', path: 'profile.html', icon: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' },
        { name: 'Messages', path: 'messages.html', icon: 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 4.582 9 8z' },
        { name: 'Settings', path: 'settings.html', icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z' },
      ];

      return (
        <div className={`sidebar dark-gradient ${isSidebarCollapsed ? 'sidebar-collapsed' : 'sidebar-expanded'} fixed top-0 left-0 h-screen text-white`}>
          <div className="flex items-center justify-between p-4">
            {!isSidebarCollapsed && <h2 className="text-xl font-semibold">ConnectedX</h2>}
            <button onClick={toggleSidebar} className="text-white focus:outline-none">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={isSidebarCollapsed ? 'M9 5h12M9 12h12M9 19h12' : 'M4 6h16M4 12h16M4 18h16'} />
              </svg>
            </button>
          </div>
          <nav>
            {navItems.map(item => (
              <a key={item.name} href={item.path} className="nav-item flex items-center p-4 relative" aria-label={item.name}>
                <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={item.icon} />
                </svg>
                {!isSidebarCollapsed && <span>{item.name}</span>}
                {isSidebarCollapsed && <span className="tooltip">{item.name}</span>}
              </a>
            ))}
          </nav>
        </div>
      );
    };

    const Header = ({ userName }) => {
      const isAdmin = localStorage.getItem('isAdmin') === 'true';
      
      return (
        <div className="bg-white flex justify-between items-center p-4">
          <div className="flex items-center">
            <img src="images/logo.svg" alt="User avatar" className="w-10 h-10 rounded-full mr-4" />
            <h1 className="text-xl font-semibold text-gray-800">
              Welcome to <span className="text-gray-800">ConnectedX</span>
              {isAdmin && <span className="ml-2 text-xs bg-red-600 text-white px-2 py-1 rounded">ADMIN</span>}
            </h1>
          </div>
          <div className="flex items-center space-x-4">
            <input type="text" placeholder="Search" className="border rounded-lg p-2 w-48 bg-white text-gray-800 placeholder-gray-500" />
            <button>
              <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 00-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 01-6 0v-1m6 0H9" />
              </svg>
            </button>
            {isAdmin && (
              <a
                href="admin.html"
                className="flex items-center gap-1 text-red-600 hover:text-red-700 font-medium"
                title="Admin Panel"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Admin
              </a>
            )}
            <a href="profile.html" className="flex items-center hover:opacity-80 transition">
              <img src="images/pfp.jpg" alt="Profile" className="w-8 h-8 rounded-full mr-2" />
              <span className="text-gray-800">{userName || 'User'}</span>
            </a>
            <button
              className="text-gray-600"
              onClick={() => {
                localStorage.clear();
                window.location.href = 'login.html';
              }}
              title="Logout"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
            </button>
          </div>
        </div>
      );
    };

    const SummaryReport = ({ communityScore, coursesInProgress, userProfile }) => (
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div className="card p-4">
          <h3 className="text-sm font-medium text-gray-500">Courses in Progress</h3>
          <p className="text-2xl font-semibold text-gray-800">{coursesInProgress}</p>
          <p className="text-xs text-gray-500">Keep up the great work!</p>
        </div>
        <div className="card p-4">
          <h3 className="text-sm font-medium text-gray-500">Groups Joined</h3>
          <p className="text-2xl font-semibold text-gray-800">{userProfile?.groupsJoined || 0}</p>
          <p className="text-xs text-gray-500">Collaborate and learn!</p>
        </div>
        <div className="card p-4">
          <h3 className="text-sm font-medium text-gray-500">Courses Completed</h3>
          <p className="text-2xl font-semibold text-gray-800">{userProfile?.coursesCompleted || 0}</p>
          <p className="text-xs text-gray-500">Keep up the momentum!</p>
        </div>
        <div className="card p-4">
          <h3 className="text-sm font-medium text-gray-500">Community Score</h3>
          <p className="text-2xl font-semibold text-gray-800">{communityScore}</p>
          <p className="text-xs text-gray-500">Great engagement!</p>
        </div>
      </div>
    );

    const Calendar = () => {
      const [currentMonth, setCurrentMonth] = useState(new Date(2025, 4));
      const today = new Date(2025, 4, 17);
      const events = {
        '2025-05-15': ['Natural Language Processing', '15:00-15:30'],
        '2025-05-16': ['Artificial Intelligence', '15:00-15:30'],
        '2025-05-17': ['Neural Networks', '15:00-15:30'],
      };

      const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate();
      const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay();
      const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
      const emptyDays = Array.from({ length: firstDayOfMonth }, (_, i) => i);

      const prevMonth = () => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1));
      const nextMonth = () => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1));

      return (
        <div className="card p-4">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-semibold text-gray-800">My Schedule</h3>
            <div className="flex items-center space-x-2">
              <button onClick={prevMonth}>
                <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <span className="text-gray-800">{currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}</span>
              <button onClick={nextMonth}>
                <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" />
                </svg>
              </button>
            </div>
          </div>
          <div className="grid grid-cols-7 gap-2 text-center">
            {['Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'].map(day => (
              <div key={day} className="text-sm font-medium text-gray-500">{day}</div>
            ))}
            {emptyDays.map((_, i) => <div key={`empty-${i}`} />)}
            {days.map(day => {
              const dateStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
              const isToday = day === today.getDate() && currentMonth.getMonth() === today.getMonth() && currentMonth.getFullYear() === today.getFullYear();
              const hasEvent = events[dateStr];
              return (
                <div key={day} className={`calendar-day p-2 rounded-lg text-gray-800 ${isToday ? 'today' : ''} ${hasEvent ? 'event' : ''}`}>
                  {day}
                </div>
              );
            })}
          </div>
          <div className="mt-4">
            {Object.entries(events).map(([date, [title, time]]) => (
              <div key={date} className="flex justify-between text-sm text-gray-600 mt-2">
                <span>{title}</span>
                <span className="text-[#60a5fa]">{time}</span>
              </div>
            ))}
          </div>
        </div>
      );
    };

    const MyConnections = () => (
      <div className="card p-4">
        <h3 className="text-lg font-semibold text-gray-800 mb-4">My Connections</h3>
        <div className="space-y-4">
          <div className="flex items-center">
            <img src="images/person1.jpg" alt="Teacher" className="w-10 h-10 rounded-full mr-3" />
            <div>
              <p className="text-sm font-medium text-gray-800">Isabel Nelson</p>
              <p className="text-xs text-[#60a5fa]">Java, JavaScript</p>
            </div>
          </div>
          <div className="flex items-center">
            <img src="images/person2.jpg" alt="Teacher" className="w-10 h-10 rounded-full mr-3" />
            <div>
              <p className="text-sm font-medium text-gray-800">Anton Shevchuk</p>
              <p className="text-xs text-[#60a5fa]">Python, C++</p>
            </div>
          </div>
          <div className="flex items-center">
            <img src="images/person3.jpg" alt="Teacher" className="w-10 h-10 rounded-full mr-3" />
            <div>
              <p className="text-sm font-medium text-gray-800">Ethan Martin</p>
              <p className="text-xs text-[#60a5fa]">Python, C++</p>
            </div>
          </div>
        </div>
      </div>
    );

    const UpcomingEvents = () => (
      <div className="card p-4">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-lg font-semibold text-gray-800">Upcoming Events</h3>
          <a href="#" className="text-sm text-[#60a5fa] link-hover">See All</a>
        </div>
        <div className="space-y-4">
          <a href={`event.html?id=${encodeURIComponent('Coding: What is eaten with?')}`} className="block hover:bg-gray-100 rounded-lg transition-transform transition-shadow duration-200 ease-in-out hover:scale-105 hover:shadow-lg">
            <div className="flex items-center p-2">
              <img src="images/event.jpg" alt="Event" className="w-10 h-10 rounded-lg mr-3" />
              <div>
                <p className="text-sm font-medium text-gray-800">Coding: What is eaten with?</p>
                <p className="text-xs text-[#60a5fa]">14.12.2023, 12:00</p>
              </div>
            </div>
          </a>
          <a href={`event.html?id=${encodeURIComponent('ICML International Conference on Machine...')}`} className="block hover:bg-gray-100 rounded-lg transition-transform transition-shadow duration-200 ease-in-out hover:scale-105 hover:shadow-lg">
            <div className="flex items-center p-2">
              <img src="images/pp.jpg" alt="Event" className="w-10 h-10 rounded-lg mr-3" />
              <div>
                <p className="text-sm font-medium text-gray-800">ICML International Conference on Machine...</p>
                <p className="text-xs text-[#60a5fa]">21.12.2023, 14:00</p>
              </div>
            </div>
          </a>
        </div>
      </div>
    );

    const MyProjects = ({ courses, enrollments, loading }) => {
      if (loading) {
        return (
          <div className="card p-4">
            <h3 className="text-lg font-semibold text-gray-800 mb-4">My Courses</h3>
            <div className="text-center py-8 text-gray-500">Loading courses...</div>
          </div>
        );
      }

      if (!courses || courses.length === 0) {
        return (
          <div className="card p-4">
            <h3 className="text-lg font-semibold text-gray-800 mb-4">My Courses</h3>
            <div className="text-center py-8 text-gray-500">No courses available</div>
          </div>
        );
      }

      return (
        <div className="card p-4">
          <h3 className="text-lg font-semibold text-gray-800 mb-4">Available Courses</h3>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            {courses.map(course => {
              // FIX: Check if courseId exists before accessing _id
              const isEnrolled = enrollments.some(e => e.courseId && e.courseId._id === course._id);
              return (
                <a 
                  key={course._id} 
                  href={`course.html?id=${course._id}&name=${encodeURIComponent(course.courseName)}`} 
                  className="block hover:bg-gray-100 rounded-lg transition-transform transition-shadow duration-200 ease-in-out hover:scale-105 hover:shadow-lg"
                >
                  <div className="p-2">
                    <img src={course.imageUrl} alt={course.courseName} className="w-full rounded-lg mb-2" />
                    <p className="text-sm font-medium text-gray-800">{course.courseName}</p>
                    <p className="text-xs text-[#60a5fa]">{course.instructor}</p>
                    {isEnrolled && (
                      <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded mt-1 inline-block">
                        Enrolled
                      </span>
                    )}
                  </div>
                </a>
              );
            })}
          </div>
        </div>
      );
    };

    const Dashboard = () => {
      const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
      const [communityScore, setCommunityScore] = useState(0);
      const [coursesInProgress, setCoursesInProgress] = useState(0);
      const [userName, setUserName] = useState('');
      const [userId, setUserId] = useState('');
      const [courses, setCourses] = useState([]);
      const [enrollments, setEnrollments] = useState([]);
      const [userProfile, setUserProfile] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        // Get user data from localStorage
        const storedUserId = localStorage.getItem('userId');
        const storedUserName = localStorage.getItem('userName');
        const isAdmin = localStorage.getItem('isAdmin');
        
        if (!storedUserId) {
          // Not logged in, redirect to login
          window.location.href = 'login.html';
          return;
        }

        // If admin, show option to go to admin panel but allow viewing dashboard
        if (isAdmin === 'true') {
          console.log('Admin logged in - has access to both dashboard and admin panel');
        }

        setUserId(storedUserId);
        setUserName(storedUserName);

        // Fetch data
        fetchDashboardData(storedUserId);
      }, []);

      const fetchDashboardData = async (userId) => {
        try {
          // Fetch all data in parallel
          const [coursesRes, profileRes, enrollmentsRes] = await Promise.all([
            fetch(`${API_URL}/api/courses`),
            fetch(`${API_URL}/api/profile/${userId}`),
            fetch(`${API_URL}/api/enrollments/student/${userId}`)
          ]);

          const coursesData = await coursesRes.json();
          const profileData = await profileRes.json();
          const enrollmentsData = await enrollmentsRes.json();

          // Set courses
          if (coursesData.status === 'Success') {
            setCourses(coursesData.courses);
          }

          // Set profile data
          if (profileData.status === 'Success') {
            setUserProfile(profileData.profile);
            setCommunityScore(profileData.profile.communityScore || 0);
          }

          // Set enrollments - Filter out invalid enrollments
          if (enrollmentsData.status === 'Success') {
            // FIX: Filter out enrollments where courseId is null
            const validEnrollments = enrollmentsData.enrollments.filter(e => e.courseId != null);
            setEnrollments(validEnrollments);
            // Count courses in progress (enrolled but not completed)
            const inProgress = validEnrollments.filter(e => e.status === 'enrolled').length;
            setCoursesInProgress(inProgress);
          }

          setLoading(false);
        } catch (error) {
          console.error('Error fetching dashboard data:', error);
          setLoading(false);
        }
      };

      const toggleSidebar = () => setIsSidebarCollapsed(!isSidebarCollapsed);

      return (
        <div>
          <NavBar isSidebarCollapsed={isSidebarCollapsed} toggleSidebar={toggleSidebar} />
          <div className={`main-content bg-white ${isSidebarCollapsed ? 'ml-[60px]' : 'ml-[250px]'} p-6 min-h-screen`}>
            <Header userName={userName} />
            <SummaryReport 
              communityScore={communityScore} 
              coursesInProgress={coursesInProgress}
              userProfile={userProfile}
            />
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
              <div className="lg:col-span-2">
                <Calendar />
              </div>
              <div className="space-y-6">
                <MyConnections />
                <UpcomingEvents />
              </div>
            </div>
            <MyProjects courses={courses} enrollments={enrollments} loading={loading} />
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Dashboard />);
  </script>
</body>

</html>