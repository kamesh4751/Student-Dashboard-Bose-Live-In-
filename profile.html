<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - ConnectedX</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f9fafb;
    }
    .dark-gradient {
      background: linear-gradient(180deg, #1f2937 0%, #374151 100%);
    }
    .sidebar { transition: width 0.3s; }
    .sidebar-collapsed { width: 60px; }
    .sidebar-expanded { width: 250px; }
    .main-content { transition: margin-left 0.3s; }
    .card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .tooltip {
      visibility: hidden;
      position: absolute;
      background-color: #1a202c;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 10;
      left: 70px;
    }
    .sidebar-collapsed .nav-item:hover .tooltip { visibility: visible; }
    .nav-item:hover { background-color: #4b5563; }
    .tag {
      display: inline-block;
      padding: 4px 12px;
      background-color: #e5e7eb;
      border-radius: 16px;
      margin: 4px;
      font-size: 14px;
    }
    .tag button {
      margin-left: 8px;
      color: #6b7280;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_URL = 'http://localhost:3001';

    const NavBar = ({ isSidebarCollapsed, toggleSidebar }) => {
      const navItems = [
        { name: 'Dashboard', path: 'index.html', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
        { name: 'Study Groups', path: 'study-groups.html', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' },
        { name: 'My Profile', path: 'profile.html', icon: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' },
      ];

      return (
        <div className={`sidebar dark-gradient ${isSidebarCollapsed ? 'sidebar-collapsed' : 'sidebar-expanded'} fixed top-0 left-0 h-screen text-white`}>
          <div className="flex items-center justify-between p-4">
            {!isSidebarCollapsed && <h2 className="text-xl font-semibold">ConnectedX</h2>}
            <button onClick={toggleSidebar} className="text-white focus:outline-none">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={isSidebarCollapsed ? 'M9 5h12M9 12h12M9 19h12' : 'M4 6h16M4 12h16M4 18h16'} />
              </svg>
            </button>
          </div>
          <nav>
            {navItems.map(item => (
              <a key={item.name} href={item.path} className="nav-item flex items-center p-4 relative">
                <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={item.icon} />
                </svg>
                {!isSidebarCollapsed && <span>{item.name}</span>}
                {isSidebarCollapsed && <span className="tooltip">{item.name}</span>}
              </a>
            ))}
          </nav>
        </div>
      );
    };

    const ProfilePage = () => {
      const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
      const [userId, setUserId] = useState('');
      const [userData, setUserData] = useState(null);
      const [profile, setProfile] = useState(null);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      
      const [formData, setFormData] = useState({
        bio: '',
        location: '',
        preferredStudyTime: 'flexible',
        studyMode: 'both',
        interests: [],
        skills: [],
        github: '',
        linkedin: ''
      });

      const [newInterest, setNewInterest] = useState('');
      const [newSkill, setNewSkill] = useState('');

      useEffect(() => {
        const storedUserId = localStorage.getItem('userId');
        if (!storedUserId) {
          window.location.href = 'login.html';
          return;
        }
        setUserId(storedUserId);
        fetchProfile(storedUserId);
      }, []);

      const fetchProfile = async (userId) => {
        try {
          const res = await fetch(`${API_URL}/api/profile/${userId}`);
          const data = await res.json();
          
          if (data.status === 'Success') {
            setProfile(data.profile);
            setUserData(data.profile.userId);
            setFormData({
              bio: data.profile.bio || '',
              location: data.profile.location || '',
              preferredStudyTime: data.profile.preferredStudyTime || 'flexible',
              studyMode: data.profile.studyMode || 'both',
              interests: data.profile.interests || [],
              skills: data.profile.skills || [],
              github: data.profile.github || '',
              linkedin: data.profile.linkedin || ''
            });
          }
          setLoading(false);
        } catch (err) {
          console.error('Error fetching profile:', err);
          setLoading(false);
        }
      };

      const handleAddInterest = () => {
        if (newInterest.trim() && !formData.interests.includes(newInterest.trim())) {
          setFormData({
            ...formData,
            interests: [...formData.interests, newInterest.trim()]
          });
          setNewInterest('');
        }
      };

      const handleRemoveInterest = (interest) => {
        setFormData({
          ...formData,
          interests: formData.interests.filter(i => i !== interest)
        });
      };

      const handleAddSkill = () => {
        if (newSkill.trim() && !formData.skills.includes(newSkill.trim())) {
          setFormData({
            ...formData,
            skills: [...formData.skills, newSkill.trim()]
          });
          setNewSkill('');
        }
      };

      const handleRemoveSkill = (skill) => {
        setFormData({
          ...formData,
          skills: formData.skills.filter(s => s !== skill)
        });
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSaving(true);

        try {
          const res = await fetch(`${API_URL}/api/profile/${userId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });

          const data = await res.json();
          
          if (data.status === 'Success') {
            alert('Profile updated successfully!');
            setProfile(data.profile);
          } else {
            alert('Failed to update profile');
          }
        } catch (err) {
          console.error('Error updating profile:', err);
          alert('Error updating profile');
        } finally {
          setSaving(false);
        }
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center min-h-screen">
            <p className="text-gray-500">Loading profile...</p>
          </div>
        );
      }

      return (
        <div>
          <NavBar isSidebarCollapsed={isSidebarCollapsed} toggleSidebar={() => setIsSidebarCollapsed(!isSidebarCollapsed)} />
          
          <div className={`main-content ${isSidebarCollapsed ? 'ml-[60px]' : 'ml-[250px]'} p-6 min-h-screen`}>
            <div className="max-w-4xl mx-auto">
              {/* Header */}
              <div className="mb-6">
                <h1 className="text-3xl font-bold text-gray-800">My Profile</h1>
                <p className="text-gray-600">Manage your account settings and preferences</p>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Left: Profile Summary */}
                <div className="lg:col-span-1">
                  <div className="card p-6 text-center">
                    <div className="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                      <span className="text-white text-3xl font-bold">
                        {userData?.name.charAt(0).toUpperCase()}
                      </span>
                    </div>
                    <h2 className="text-xl font-bold text-gray-800">{userData?.name}</h2>
                    <p className="text-gray-600 text-sm">{userData?.email}</p>
                    <p className="text-blue-600 text-sm mt-1">ID: {userData?.stuid}</p>

                    <div className="mt-6 space-y-2 text-left">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Community Score</span>
                        <span className="font-bold text-blue-600">{profile?.communityScore || 0}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Courses Completed</span>
                        <span className="font-bold text-gray-800">{profile?.coursesCompleted || 0}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Groups Joined</span>
                        <span className="font-bold text-gray-800">{profile?.groupsJoined || 0}</span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Right: Edit Form */}
                <div className="lg:col-span-2">
                  <form onSubmit={handleSubmit} className="card p-6 space-y-6">
                    {/* Bio */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                      <textarea
                        value={formData.bio}
                        onChange={(e) => setFormData({...formData, bio: e.target.value})}
                        rows="3"
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        placeholder="Tell others about yourself..."
                      />
                    </div>

                    {/* Location */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Location</label>
                      <input
                        type="text"
                        value={formData.location}
                        onChange={(e) => setFormData({...formData, location: e.target.value})}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        placeholder="e.g., New York, USA"
                      />
                    </div>

                    {/* Study Preferences */}
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Preferred Study Time</label>
                        <select
                          value={formData.preferredStudyTime}
                          onChange={(e) => setFormData({...formData, preferredStudyTime: e.target.value})}
                          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        >
                          <option value="morning">Morning</option>
                          <option value="afternoon">Afternoon</option>
                          <option value="evening">Evening</option>
                          <option value="night">Night</option>
                          <option value="flexible">Flexible</option>
                        </select>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Study Mode</label>
                        <select
                          value={formData.studyMode}
                          onChange={(e) => setFormData({...formData, studyMode: e.target.value})}
                          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        >
                          <option value="online">Online</option>
                          <option value="offline">Offline</option>
                          <option value="both">Both</option>
                        </select>
                      </div>
                    </div>

                    {/* Interests */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Interests</label>
                      <div className="flex gap-2 mb-2">
                        <input
                          type="text"
                          value={newInterest}
                          onChange={(e) => setNewInterest(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddInterest())}
                          className="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                          placeholder="Add an interest..."
                        />
                        <button
                          type="button"
                          onClick={handleAddInterest}
                          className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                        >
                          Add
                        </button>
                      </div>
                      <div className="flex flex-wrap">
                        {formData.interests.map((interest, idx) => (
                          <span key={idx} className="tag">
                            {interest}
                            <button type="button" onClick={() => handleRemoveInterest(interest)}>×</button>
                          </span>
                        ))}
                      </div>
                    </div>

                    {/* Skills */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Skills</label>
                      <div className="flex gap-2 mb-2">
                        <input
                          type="text"
                          value={newSkill}
                          onChange={(e) => setNewSkill(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), handleAddSkill())}
                          className="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                          placeholder="Add a skill..."
                        />
                        <button
                          type="button"
                          onClick={handleAddSkill}
                          className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                        >
                          Add
                        </button>
                      </div>
                      <div className="flex flex-wrap">
                        {formData.skills.map((skill, idx) => (
                          <span key={idx} className="tag">
                            {skill}
                            <button type="button" onClick={() => handleRemoveSkill(skill)}>×</button>
                          </span>
                        ))}
                      </div>
                    </div>

                    {/* Social Links */}
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">GitHub</label>
                        <input
                          type="text"
                          value={formData.github}
                          onChange={(e) => setFormData({...formData, github: e.target.value})}
                          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                          placeholder="github.com/username"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">LinkedIn</label>
                        <input
                          type="text"
                          value={formData.linkedin}
                          onChange={(e) => setFormData({...formData, linkedin: e.target.value})}
                          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                          placeholder="linkedin.com/in/username"
                        />
                      </div>
                    </div>

                    {/* Submit Button */}
                    <div className="flex gap-4 pt-4">
                      <button
                        type="submit"
                        disabled={saving}
                        className={`flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition font-medium ${
                          saving ? 'opacity-50 cursor-not-allowed' : ''
                        }`}
                      >
                        {saving ? 'Saving...' : 'Save Changes'}
                      </button>
                      <a
                        href="index.html"
                        className="flex-1 text-center bg-gray-200 text-gray-800 py-3 px-6 rounded-lg hover:bg-gray-300 transition font-medium"
                      >
                        Cancel
                      </a>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ProfilePage />);
  </script>
</body>
</html>
