<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Groups - ConnectedX</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f9fafb;
    }
    .dark-gradient {
      background: linear-gradient(180deg, #1f2937 0%, #374151 100%);
    }
    .sidebar { transition: width 0.3s; }
    .sidebar-collapsed { width: 60px; }
    .sidebar-expanded { width: 250px; }
    .main-content { transition: margin-left 0.3s; }
    .card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .tooltip {
      visibility: hidden;
      position: absolute;
      background-color: #1a202c;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 10;
      left: 70px;
    }
    .sidebar-collapsed .nav-item:hover .tooltip { visibility: visible; }
    .nav-item:hover { background-color: #4b5563; }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_URL = 'http://localhost:3001';

    const NavBar = ({ isSidebarCollapsed, toggleSidebar }) => {
      const navItems = [
        { name: 'Dashboard', path: 'index.html', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
        { name: 'Study Groups', path: 'study-groups.html', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' },
        { name: 'Messages', path: 'messages.html', icon: 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 4.582 9 8z' },
        { name: 'Settings', path: 'settings.html', icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z' },
      ];

      return (
        <div className={`sidebar dark-gradient ${isSidebarCollapsed ? 'sidebar-collapsed' : 'sidebar-expanded'} fixed top-0 left-0 h-screen text-white`}>
          <div className="flex items-center justify-between p-4">
            {!isSidebarCollapsed && <h2 className="text-xl font-semibold">ConnectedX</h2>}
            <button onClick={toggleSidebar} className="text-white focus:outline-none">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={isSidebarCollapsed ? 'M9 5h12M9 12h12M9 19h12' : 'M4 6h16M4 12h16M4 18h16'} />
              </svg>
            </button>
          </div>
          <nav>
            {navItems.map(item => (
              <a key={item.name} href={item.path} className="nav-item flex items-center p-4 relative">
                <svg className="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={item.icon} />
                </svg>
                {!isSidebarCollapsed && <span>{item.name}</span>}
                {isSidebarCollapsed && <span className="tooltip">{item.name}</span>}
              </a>
            ))}
          </nav>
        </div>
      );
    };

    const CreateGroupModal = ({ isOpen, onClose, courses, userId, onGroupCreated }) => {
      const [formData, setFormData] = useState({
        groupName: '',
        description: '',
        courseId: '',
        maxMembers: 6,
        isPrivate: false,
        groupType: 'study'
      });

      if (!isOpen) return null;

      const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!formData.groupName || !formData.courseId) {
          alert('Please fill in group name and select a course');
          return;
        }

        try {
          const res = await fetch(`${API_URL}/api/groups`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ...formData,
              createdBy: userId
            })
          });

          const data = await res.json();
          
          if (data.status === 'Success') {
            alert('Study group created successfully!');
            onGroupCreated();
            onClose();
            setFormData({
              groupName: '',
              description: '',
              courseId: '',
              maxMembers: 6,
              isPrivate: false,
              groupType: 'study'
            });
          } else {
            alert('Failed to create group: ' + data.message);
          }
        } catch (err) {
          console.error('Error creating group:', err);
          alert('Error creating group');
        }
      };

      return (
        <div className="modal" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-2xl font-bold text-gray-800">Create Study Group</h2>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Group Name *</label>
                <input
                  type="text"
                  value={formData.groupName}
                  onChange={(e) => setFormData({...formData, groupName: e.target.value})}
                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="e.g., Python Study Group"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea
                  value={formData.description}
                  onChange={(e) => setFormData({...formData, description: e.target.value})}
                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  rows="3"
                  placeholder="What will your group focus on?"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Course *</label>
                <select
                  value={formData.courseId}
                  onChange={(e) => setFormData({...formData, courseId: e.target.value})}
                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                  required
                >
                  <option value="">Select a course</option>
                  {courses.map(course => (
                    <option key={course._id} value={course._id}>
                      {course.courseName}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Max Members</label>
                <input
                  type="number"
                  value={formData.maxMembers}
                  onChange={(e) => setFormData({...formData, maxMembers: parseInt(e.target.value)})}
                  min="2"
                  max="20"
                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Group Type</label>
                <select
                  value={formData.groupType}
                  onChange={(e) => setFormData({...formData, groupType: e.target.value})}
                  className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="study">Study Group</option>
                  <option value="project">Project Team</option>
                  <option value="discussion">Discussion Group</option>
                  <option value="exam-prep">Exam Preparation</option>
                </select>
              </div>

              <div className="flex items-center">
                <input
                  type="checkbox"
                  id="isPrivate"
                  checked={formData.isPrivate}
                  onChange={(e) => setFormData({...formData, isPrivate: e.target.checked})}
                  className="mr-2"
                />
                <label htmlFor="isPrivate" className="text-sm text-gray-700">Make this group private</label>
              </div>

              <div className="flex gap-2 pt-4">
                <button
                  type="submit"
                  className="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition"
                >
                  Create Group
                </button>
                <button
                  type="button"
                  onClick={onClose}
                  className="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    const GroupCard = ({ group, userId, onJoinLeave }) => {
      // FIX: Check if courseId exists
      if (!group.courseId) {
        return null; // Don't render groups with invalid course references
      }

      const isMember = group.members.some(m => m.userId._id === userId);
      const isAdmin = group.createdBy._id === userId;
      const isFull = group.members.length >= group.maxMembers;

      const handleAction = async () => {
        if (isMember) {
          // Leave group
          if (window.confirm('Are you sure you want to leave this group?')) {
            try {
              const res = await fetch(`${API_URL}/api/groups/${group._id}/leave`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId })
              });
              const data = await res.json();
              if (data.status === 'Success') {
                alert('Left group successfully');
                onJoinLeave();
              }
            } catch (err) {
              console.error('Error leaving group:', err);
              alert('Error leaving group');
            }
          }
        } else {
          // Join group
          if (isFull) {
            alert('This group is full');
            return;
          }
          try {
            const res = await fetch(`${API_URL}/api/groups/${group._id}/join`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ userId })
            });
            const data = await res.json();
            if (data.status === 'Success') {
              alert('Joined group successfully!');
              onJoinLeave();
            } else {
              alert(data.message || 'Failed to join group');
            }
          } catch (err) {
            console.error('Error joining group:', err);
            alert('Error joining group');
          }
        }
      };

      return (
        <div className="card p-6 hover:shadow-lg transition">
          <div className="flex justify-between items-start mb-3">
            <div>
              <h3 className="text-lg font-bold text-gray-800">{group.groupName}</h3>
              <p className="text-sm text-blue-600">{group.courseId.courseName}</p>
            </div>
            <span className={`text-xs px-2 py-1 rounded ${
              isFull ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'
            }`}>
              {group.members.length}/{group.maxMembers} Members
            </span>
          </div>

          <p className="text-sm text-gray-600 mb-4">
            {group.description || 'No description provided'}
          </p>

          <div className="flex items-center justify-between text-xs text-gray-500 mb-4">
            <span>ðŸ‘¤ Created by {group.createdBy.name}</span>
            <span className="capitalize px-2 py-1 bg-gray-100 rounded">{group.groupType}</span>
          </div>

          <div className="flex gap-2">
            <button
              onClick={handleAction}
              disabled={!isMember && isFull}
              className={`flex-1 py-2 px-4 rounded-lg font-medium transition ${
                isMember 
                  ? 'bg-red-100 text-red-700 hover:bg-red-200' 
                  : isFull
                  ? 'bg-gray-200 text-gray-500 cursor-not-allowed'
                  : 'bg-blue-600 text-white hover:bg-blue-700'
              }`}
            >
              {isMember ? 'Leave Group' : isFull ? 'Group Full' : 'Join Group'}
            </button>
            <a 
              href={`group-detail.html?id=${group._id}`}
              className="py-2 px-4 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition"
            >
              View
            </a>
          </div>
        </div>
      );
    };

    const StudyGroupsPage = () => {
      const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
      const [groups, setGroups] = useState([]);
      const [courses, setCourses] = useState([]);
      const [userId, setUserId] = useState('');
      const [loading, setLoading] = useState(true);
      const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
      const [filterCourse, setFilterCourse] = useState('');
      const [searchQuery, setSearchQuery] = useState('');

      useEffect(() => {
        const storedUserId = localStorage.getItem('userId');
        if (!storedUserId) {
          window.location.href = 'login.html';
          return;
        }
        setUserId(storedUserId);
        fetchData();
      }, []);

      const fetchData = async () => {
        try {
          const [groupsRes, coursesRes] = await Promise.all([
            fetch(`${API_URL}/api/groups`),
            fetch(`${API_URL}/api/courses`)
          ]);

          const groupsData = await groupsRes.json();
          const coursesData = await coursesRes.json();

          if (groupsData.status === 'Success') {
            // FIX: Filter out groups with null courseId
            const validGroups = groupsData.groups.filter(g => g.courseId != null);
            setGroups(validGroups);
          }
          if (coursesData.status === 'Success') {
            setCourses(coursesData.courses);
          }
          setLoading(false);
        } catch (err) {
          console.error('Error fetching data:', err);
          setLoading(false);
        }
      };

      const filteredGroups = groups.filter(g => {
        // FIX: Check if courseId exists
        if (!g.courseId) return false;
        
        // Filter by course
        const matchesCourse = filterCourse ? g.courseId._id === filterCourse : true;
        
        // Filter by search query
        const matchesSearch = searchQuery 
          ? g.groupName.toLowerCase().includes(searchQuery.toLowerCase()) ||
            g.description?.toLowerCase().includes(searchQuery.toLowerCase()) ||
            g.courseId.courseName.toLowerCase().includes(searchQuery.toLowerCase())
          : true;
        
        return matchesCourse && matchesSearch;
      });

      return (
        <div>
          <NavBar isSidebarCollapsed={isSidebarCollapsed} toggleSidebar={() => setIsSidebarCollapsed(!isSidebarCollapsed)} />
          
          <div className={`main-content ${isSidebarCollapsed ? 'ml-[60px]' : 'ml-[250px]'} p-6 min-h-screen`}>
            {/* Header */}
            <div className="flex justify-between items-center mb-6">
              <div>
                <h1 className="text-3xl font-bold text-gray-800">Study Groups</h1>
                <p className="text-gray-600">Join or create study groups for your courses</p>
              </div>
              <button
                onClick={() => setIsCreateModalOpen(true)}
                className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" />
                </svg>
                Create Group
              </button>
            </div>

            {/* Filter and Search */}
            <div className="mb-6 flex flex-col md:flex-row gap-4">
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search groups by name, description, or course..."
                className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
              />
              <select
                value={filterCourse}
                onChange={(e) => setFilterCourse(e.target.value)}
                className="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 min-w-[200px]"
              >
                <option value="">All Courses</option>
                {courses.map(course => (
                  <option key={course._id} value={course._id}>
                    {course.courseName}
                  </option>
                ))}
              </select>
            </div>
            <div className="mb-4 text-gray-600">
              Showing {filteredGroups.length} of {groups.length} group(s)
              {searchQuery && <span className="ml-2 text-blue-600">â€¢ Searching: "{searchQuery}"</span>}
            </div>

            {/* Groups Grid */}
            {loading ? (
              <div className="text-center py-12">
                <p className="text-gray-500">Loading groups...</p>
              </div>
            ) : filteredGroups.length === 0 ? (
              <div className="text-center py-12">
                <p className="text-gray-500 mb-4">No study groups found</p>
                <button
                  onClick={() => setIsCreateModalOpen(true)}
                  className="text-blue-600 hover:underline"
                >
                  Create the first group!
                </button>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {filteredGroups.map(group => (
                  <GroupCard 
                    key={group._id} 
                    group={group} 
                    userId={userId}
                    onJoinLeave={fetchData}
                  />
                ))}
              </div>
            )}
          </div>

          <CreateGroupModal
            isOpen={isCreateModalOpen}
            onClose={() => setIsCreateModalOpen(false)}
            courses={courses}
            userId={userId}
            onGroupCreated={fetchData}
          />
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<StudyGroupsPage />);
  </script>
</body>
</html>